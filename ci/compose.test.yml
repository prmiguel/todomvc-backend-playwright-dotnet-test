services:

  workflow:
    image: code.forgejo.org/oci/alpine:3.22
    links:
      - forgejo
    command: >-
      sh -ec '
      apk add --quiet git curl jq ;
      ls -la /code ;
      cd /code ;
      git config --global --add safe.directory /code ;
      git status
      git config user.email root@example.com ;
      git config user.name username ;
      while : ; do
        git push --set-upstream --force http://root:testing@forgejo:3000/root/todomvc-backend-playwright-dotnet-test main && break ;
        sleep 5 ;
      done ;
      sha=`git rev-parse HEAD` ;
      for delay in 1 1 1 1 2 5 5 10 10 10 15 30 30 30 30 30 30 30 ; do
        curl -sS -f http://forgejo:3000/api/v1/repos/root/todomvc-backend-playwright-dotnet-test/commits/$$sha/status | jq --raw-output .state | tee status ;
        if grep success status ; then echo DEMO WORKFLOW SUCCESS && break ; fi ;
        if grep failure status ; then echo DEMO WORKFLOW FAILURE && break ; fi ;
        sleep $$delay ;
      done ;
      grep success status || echo DEMO WORKFLOW FAILURE
      '
    volumes:
      - $PWD:/code